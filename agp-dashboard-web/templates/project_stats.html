{% extends "base.html" %}

{% block title %}Estadísticas de Proyectos - AGP Dashboard{% endblock %}

{% block styles %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
        background-color: var(--bg-secondary);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px var(--shadow-color);
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Estadísticas de Proyectos</h1>

<div class="card mb-4">
    <div class="card-header">
        Lista de Proyectos
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th>Estado</th>
                        <th>Última Modificación</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in all_projects %}
                    <tr>
                        <td>{{ project.nombre }}</td>
                        <td>{{ project.descripcion }}</td>
                        <td><span class="badge bg-primary">{{ project.estado }}</span></td>
                        <td>{{ project.ultima_modificacion }}</td>
                        <td>
                            <a href="{{ url_for('project_detail', project_name=project.nombre) }}" class="btn btn-sm btn-info">
                                <i class="bi bi-eye"></i> Ver Detalles
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="chart-container">
    <canvas id="projectStatusChart"></canvas>
</div>

<div class="chart-container">
    <canvas id="projectModificationChart"></canvas>
</div>

<div class="chart-container">
    <canvas id="taskStatusChart"></canvas>
</div>

<a href="{{ url_for('dashboard') }}" class="btn btn-secondary mt-3">Volver al Dashboard</a>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const projectStatusData = {{ project_status_data | tojson }};
    const projectModificationData = {{ project_modification_data | tojson }};
    const taskStatusData = {{ task_status_data | tojson }};

    // --- Utility Functions ---
    const getChartThemeColors = () => {
        const isDarkMode = document.body.classList.contains('dark-mode');
        return {
            textColor: isDarkMode ? '#c0caf5' : '#212529',
            gridColor: isDarkMode ? 'rgba(122, 162, 247, 0.1)' : 'rgba(0, 0, 0, 0.05)',
            primary: '#7aa2f7', 
            green: '#9ece6a', 
            yellow: '#e0af68',
            blue: '#545c7e',
            red: '#f7768e'
        };
    };

    const createNeonGradient = (ctx, color) => {
        const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
        gradient.addColorStop(0, `${color}ff`);
        gradient.addColorStop(1, `${color}33`);
        return gradient;
    };

    const colors = getChartThemeColors();

    // Gráfico de estado de proyectos (Pie Chart)
    new Chart(document.getElementById('projectStatusChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(projectStatusData),
            datasets: [{
                data: Object.values(projectStatusData),
                backgroundColor: [colors.primary, colors.green, colors.yellow, colors.blue, colors.red],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: 'Proyectos por Estado', color: colors.textColor },
                legend: { labels: { color: colors.textColor } }
            }
        }
    });

    // Gráfico de proyectos por fecha de última modificación (Bar Chart)
    const modChartCtx = document.getElementById('projectModificationChart').getContext('2d');
    new Chart(modChartCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(projectModificationData),
            datasets: [{
                label: 'Número de Proyectos',
                data: Object.values(projectModificationData),
                backgroundColor: createNeonGradient(modChartCtx, colors.green),
                borderColor: colors.green,
                borderWidth: 2,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: 'Proyectos por Año de Última Modificación', color: colors.textColor },
                legend: { display: false }
            },
            scales: {
                x: { ticks: { color: colors.textColor }, grid: { display: false } },
                y: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } }
            }
        }
    });

    // Gráfico de estado de tareas (Pie Chart)
    const taskStatusChart = new Chart(document.getElementById('taskStatusChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(taskStatusData),
            datasets: [{
                data: Object.values(taskStatusData),
                backgroundColor: [colors.yellow, colors.primary, colors.green, colors.red, colors.blue],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: 'Tareas por Estado', color: colors.textColor },
                legend: { labels: { color: colors.textColor } }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const label = taskStatusChart.data.labels[index];
                    const searchStatus = label.toLowerCase().replace(/ /g, '_');
                    const tasksUrl = new URL("{{ url_for('tasks.tasks_manager') }}", window.location.origin);
                    tasksUrl.searchParams.set('search', searchStatus);
                    window.location.href = tasksUrl.toString();
                }
            }
        }
    });
</script>
{% endblock %}