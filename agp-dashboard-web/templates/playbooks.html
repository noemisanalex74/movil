{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Gestión de Playbooks</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('playbooks.playbook_editor') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-plus-lg me-1"></i>
                Nuevo Playbook Visual
            </a>
        </div>
    </div>

    <!-- Playbooks Table -->
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th scope="col">Nombre del Playbook</th>
                    <th scope="col">Descripción</th>
                    <th scope="col">Archivo</th>
                    <th scope="col" class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for playbook in playbooks %}
                <tr>
                    <td><strong>{{ playbook.name }}</strong></td>
                    <td class="text-muted">{{ playbook.description }}</td>
                    <td><code>{{ playbook.filename }}</code></td>
                    <td class="text-end">
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#runPlaybookModal" data-playbook-filename="{{ playbook.filename }}" data-playbook-name="{{ playbook.name }}">
                            <i class="fas fa-play-circle me-1"></i> Ejecutar
                        </button>
                        <!-- View and Delete buttons can be added here -->
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4">
                        <div class="text-center p-5">
                            <svg width="150" height="150" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg" class="mb-4">
                                <style>
                                    .base { fill: #24283b; }
                                    .outline { stroke: #414868; stroke-width: 2; }
                                    .text { fill: #545c7e; font-family: sans-serif; font-size: 14px; text-anchor: middle; }
                                    .icon { stroke: #545c7e; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
                                </style>
                                <rect class="base" width="200" height="200" rx="15"/>
                                <g transform="translate(50, 40)">
                                    <path class="outline" d="M20,0 H80 C91.0457,0 100,8.9543 100,20 V90 C100,101.046 91.0457,110 80,110 H20 C8.9543,110 0,101.046 0,90 V20 C0,8.9543 8.9543,0 20,0 Z" fill="#1a1b26"/>
                                    <circle class="icon" cx="45" cy="50" r="18"/>
                                    <line class="icon" x1="58" y1="63" x2="75" y2="80"/>
                                    <line class="icon" x1="20" y1="25" x2="80" y2="25"/>
                                    <line class="icon" x1="20" y1="85" x2="60" y2="85"/>
                                </g>
                            </svg>
                            <h5 class="mt-4">No se encontraron Playbooks</h5>
                            <p class="text-muted">Crea tu primer playbook para empezar a automatizar tareas.</p>
                            <a href="{{ url_for('playbooks.playbook_editor') }}" class="btn btn-primary mt-3">
                                <i class="bi bi-plus-lg me-1"></i>
                                Nuevo Playbook Visual
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Run Playbook Modal -->
<div class="modal fade" id="runPlaybookModal" tabindex="-1" aria-labelledby="runPlaybookModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="runPlaybookForm" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="runPlaybookModalLabel">Ejecutar Playbook</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Vas a ejecutar el playbook: <strong id="playbookNameInModal"></strong></p>
                    <div class="mb-3">
                        <label for="agent_id" class="form-label">Selecciona el Agente de Destino</label>
                        <select class="form-select" id="agent_id" name="agent_id" required>
                            <option value="" selected disabled>Elige un agente...</option>
                            {% for agent in agents %}
                                {% if agent.status == 'online' %}
                                <option value="{{ agent.id }}">{{ agent.name }} ({{ agent.id }})</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        {% if not agents %}
                        <div class="form-text text-danger">No hay agentes conectados.</div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Ejecutar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const runPlaybookModal = document.getElementById('runPlaybookModal');
        runPlaybookModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const playbookFilename = button.getAttribute('data-playbook-filename');
            const playbookName = button.getAttribute('data-playbook-name');
            
            const modalForm = runPlaybookModal.querySelector('#runPlaybookForm');
            const modalTitle = runPlaybookModal.querySelector('#playbookNameInModal');
            
            const actionUrl = "{{ url_for('playbooks.list_playbooks') }}" + 'run/' + playbookFilename;
            modalForm.action = actionUrl;
            modalTitle.textContent = playbookName;
        });
    });
</script>
{% endblock %}
