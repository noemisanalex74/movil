{% extends "base.html" %}

{% block title %}Kanban de Tareas - AGP Dashboard{% endblock %}

{% block styles %}
<style>
    .kanban-board {
        display: flex;
        gap: 20px;
        overflow-x: auto;
        padding-bottom: 20px;
    }
    .kanban-column {
        flex: 1;
        min-width: 300px;
        background-color: rgba(var(--bs-secondary-bg-rgb), 0.5);
        border-radius: 12px;
        padding: 15px;
        border: 1px solid rgba(var(--bs-tertiary-bg-rgb), 1);
        transition: background-color 0.3s ease;
    }
    .kanban-column.drag-over {
        background-color: rgba(var(--bs-primary-rgb), 0.1);
        border: 1px dashed var(--primary-color);
    }
    .kanban-column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 10px;
        border-bottom: 2px solid;
        margin-bottom: 15px;
    }
    .kanban-column-header h2 {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 0;
    }
    #column-pendiente .kanban-column-header { border-color: #ffc107; }
    #column-en_progreso .kanban-column-header { border-color: #0d6efd; }
    #column-completada .kanban-column-header { border-color: #198754; }

    .kanban-card {
        background-color: var(--bs-body-bg);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        cursor: grab;
        border: 1px solid var(--bs-border-color-translucent);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .dark-mode .kanban-card { box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .kanban-card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .dark-mode .kanban-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .kanban-card:active {
        cursor: grabbing;
        transform: scale(1.03);
        box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    .kanban-card-description {
        font-weight: 500;
        margin-bottom: 12px;
    }
    .kanban-card-footer {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        font-size: 0.8rem;
        color: var(--bs-secondary-color);
    }
    .due-date-badge {
        border: 1px solid var(--bs-border-color-translucent);
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Tablero Kanban</h1>
<div class="kanban-board">
    <div class="kanban-column" id="column-pendiente">
        <div class="kanban-column-header">
            <h2><i class="bi bi-pause-circle-fill me-2" style="color: #ffc107;"></i>Pendiente</h2>
            <span class="badge rounded-pill bg-secondary">{{ tasks_pendiente|length }}</span>
        </div>
        <div class="kanban-tasks-wrapper">
            {% for task in tasks_pendiente %}
                <div class="kanban-card" draggable="true" data-task-id="{{ task.id }}" data-status="pendiente">
                    <p class="kanban-card-description">{{ task.descripcion }}</p>
                    <div class="kanban-card-footer">
                        {% if task.fecha_vencimiento %}
                            <span class="badge rounded-pill bg-light text-dark due-date-badge">
                                <i class="bi bi-clock"></i>
                                {{ task.fecha_vencimiento.split('T')[0] }}
                            </span>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <p class="text-muted text-center mt-3">No hay tareas pendientes.</p>
            {% endfor %}
        </div>
        <div class="add-task-form-container mt-2">
            <form class="add-task-form" data-status="pendiente" style="display: none;">
                <textarea class="form-control form-control-sm mb-2" placeholder="Nueva tarea..." required></textarea>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-sm btn-secondary me-2 cancel-add-task">Cancelar</button>
                    <button type="submit" class="btn btn-sm btn-primary">Guardar</button>
                </div>
            </form>
            <button class="btn btn-sm btn-outline-secondary w-100 add-task-btn"><i class="bi bi-plus"></i> Añadir tarea</button>
        </div>
    </div>
    <div class="kanban-column" id="column-en_progreso">
        <div class="kanban-column-header">
            <h2><i class="bi bi-play-circle-fill me-2" style="color: #0d6efd;"></i>En Progreso</h2>
            <span class="badge rounded-pill bg-secondary">{{ tasks_en_progreso|length }}</span>
        </div>
        <div class="kanban-tasks-wrapper">
            {% for task in tasks_en_progreso %}
                <div class="kanban-card" draggable="true" data-task-id="{{ task.id }}" data-status="en_progreso">
                    <p class="kanban-card-description">{{ task.descripcion }}</p>
                    <div class="kanban-card-footer">
                        {% if task.fecha_vencimiento %}
                            <span class="badge rounded-pill bg-light text-dark due-date-badge">
                                <i class="bi bi-clock"></i>
                                {{ task.fecha_vencimiento.split('T')[0] }}
                            </span>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <p class="text-muted text-center mt-3">No hay tareas en progreso.</p>
            {% endfor %}
        </div>
        <div class="add-task-form-container mt-2">
            <form class="add-task-form" data-status="en_progreso" style="display: none;">
                <textarea class="form-control form-control-sm mb-2" placeholder="Nueva tarea..." required></textarea>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-sm btn-secondary me-2 cancel-add-task">Cancelar</button>
                    <button type="submit" class="btn btn-sm btn-primary">Guardar</button>
                </div>
            </form>
            <button class="btn btn-sm btn-outline-secondary w-100 add-task-btn"><i class="bi bi-plus"></i> Añadir tarea</button>
        </div>
    </div>
    <div class="kanban-column" id="column-completada">
        <div class="kanban-column-header">
            <h2><i class="bi bi-check-circle-fill me-2" style="color: #198754;"></i>Completada</h2>
            <span class="badge rounded-pill bg-secondary">{{ tasks_completada|length }}</span>
        </div>
        <div class="kanban-tasks-wrapper">
            {% for task in tasks_completada %}
                <div class="kanban-card" draggable="true" data-task-id="{{ task.id }}" data-status="completada">
                    <p class="kanban-card-description">{{ task.descripcion }}</p>
                    <div class="kanban-card-footer">
                        {% if task.fecha_vencimiento %}
                            <span class="badge rounded-pill bg-light text-dark due-date-badge">
                                <i class="bi bi-clock"></i>
                                {{ task.fecha_vencimiento.split('T')[0] }}
                            </span>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <p class="text-muted text-center mt-3">No hay tareas completadas.</p>
            {% endfor %}
        </div>
        <div class="add-task-form-container mt-2">
            <form class="add-task-form" data-status="completada" style="display: none;">
                <textarea class="form-control form-control-sm mb-2" placeholder="Nueva tarea..." required></textarea>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-sm btn-secondary me-2 cancel-add-task">Cancelar</button>
                    <button type="submit" class="btn btn-sm btn-primary">Guardar</button>
                </div>
            </form>
            <button class="btn btn-sm btn-outline-secondary w-100 add-task-btn"><i class="bi bi-plus"></i> Añadir tarea</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const columns = document.querySelectorAll('.kanban-column');
        let draggedItem = null;
        let originalParent = null;

        columns.forEach(column => {
            const tasksWrapper = column.querySelector('.kanban-tasks-wrapper');

            column.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('kanban-card')) {
                    draggedItem = e.target;
                    originalParent = draggedItem.parentNode;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
                    setTimeout(() => {
                        e.target.style.display = 'none';
                    }, 0);
                }
            });

            column.addEventListener('dragend', (e) => {
                if (draggedItem) {
                    draggedItem.style.display = 'block';
                    draggedItem = null;
                    originalParent = null;
                }
            });

            const dragOverHandler = (e) => {
                e.preventDefault();
                column.classList.add('drag-over');
            };

            const dragLeaveHandler = (e) => {
                column.classList.remove('drag-over');
            };

            const dropHandler = (e) => {
                e.preventDefault();
                column.classList.remove('drag-over');

                if (!draggedItem) return;

                const targetColumn = e.target.closest('.kanban-column');
                if (targetColumn) {
                    const taskId = draggedItem.dataset.taskId;
                    const newStatus = targetColumn.id.replace('column-', '');
                    
                    // Append to the tasks wrapper inside the column
                    targetColumn.querySelector('.kanban-tasks-wrapper').appendChild(draggedItem);

                    // Send update to server
                    fetch("{{ url_for('tasks.update_task_status') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ task_id: taskId, new_status: newStatus })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            draggedItem.dataset.status = newStatus;
                        } else {
                            originalParent.appendChild(draggedItem);
                            alert('Error al actualizar la tarea: ' + (data.message || 'Error desconocido'));
                        }
                    })
                    .catch(error => {
                        console.error('Error de red:', error);
                        originalParent.appendChild(draggedItem);
                        alert('Error de conexión al actualizar la tarea.');
                    });
                }
            };

            column.addEventListener('dragover', dragOverHandler);
            column.addEventListener('dragleave', dragLeaveHandler);
            column.addEventListener('drop', dropHandler);
        });

        // SocketIO logic can remain largely the same, but might need adjustments
        // to handle the new structure if we add inline editing/creation.
    });

    // --- Lógica para añadir tareas inline ---
    document.querySelectorAll('.add-task-btn').forEach(button => {
        button.addEventListener('click', e => {
            const container = e.target.closest('.add-task-form-container');
            container.querySelector('.add-task-form').style.display = 'block';
            e.target.style.display = 'none';
        });
    });

    document.querySelectorAll('.cancel-add-task').forEach(button => {
        button.addEventListener('click', e => {
            const container = e.target.closest('.add-task-form-container');
            const form = container.querySelector('.add-task-form');
            form.style.display = 'none';
            form.querySelector('textarea').value = '';
            container.querySelector('.add-task-btn').style.display = 'block';
        });
    });

    document.querySelectorAll('.add-task-form').forEach(form => {
        form.addEventListener('submit', e => {
            e.preventDefault();
            const textarea = form.querySelector('textarea');
            const description = textarea.value.trim();
            const status = form.dataset.status;

            if (!description) return;

            const formData = new FormData();
            formData.append('descripcion', description);
            formData.append('estado', status);

            fetch("{{ url_for('tasks.task_add') }}", {
                method: 'POST',
                body: new URLSearchParams(formData),
                headers: {
                    // El token CSRF es necesario si WTForms lo está aplicando a POST requests
                    // Como no usamos JSON, el token debe estar en el form o la cabecera
                }
            })
            .then(response => {
                if (response.ok && response.redirected) {
                    window.location.href = response.url; // Recargar a donde redirige
                } else {
                    // Si falla, el backend debería devolver un error, pero por ahora recargamos
                    alert('Hubo un error al crear la tarea.');
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error de red al crear la tarea:', error);
                alert('Error de conexión al crear la tarea.');
            });
        });
    });
</script>
{% endblock %}