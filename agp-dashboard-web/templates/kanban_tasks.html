{% extends "base.html" %}

{% block title %}Kanban de Tareas - AGP Dashboard{% endblock %}

{% block styles %}
<style>
    .kanban-column {
        background-color: var(--bg-secondary);
        border-radius: 8px;
        padding: 15px;
        min-height: 300px;
        border: 1px solid var(--border-color);
        transition: background-color 0.2s ease;
    }
    .kanban-column.drag-over {
        background-color: var(--bg-highlight);
        border: 2px dashed var(--primary-color);
    }
    .kanban-card {
        background-color: var(--bg-tertiary);
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        cursor: grab;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .kanban-card:active {
        cursor: grabbing;
        transform: scale(1.02);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .kanban-column h2 {
        color: var(--text-primary);
        margin-bottom: 15px;
    }
    /* Specific colors for column headers */
    #column-pendiente h2 { color: #ffc107; } /* Warning yellow */
    #column-en_progreso h2 { color: #0d6efd; } /* Primary blue */
    #column-completada h2 { color: #198754; } /* Success green */
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Tablero Kanban de Tareas</h1>
<div class="row">
    <div class="col-md-4">
        <div class="kanban-column" id="column-pendiente">
            <h2>Pendiente</h2>
            {% for task in tasks_pendiente %}
                <div class="kanban-card" draggable="true" data-task-id="{{ task.id }}" data-status="pendiente">
                    {{ task.descripcion }}
                </div>
            {% else %}
                <p class="text-muted">No hay tareas pendientes.</p>
            {% endfor %}
        </div>
    </div>
    <div class="col-md-4">
        <div class="kanban-column" id="column-en_progreso">
            <h2>En Progreso</h2>
            {% for task in tasks_en_progreso %}
                <div class="kanban-card" draggable="true" data-task-id="{{ task.id }}" data-status="en_progreso">
                    {{ task.descripcion }}
                </div>
            {% else %}
                <p class="text-muted">No hay tareas en progreso.</p>
            {% endfor %}
        </div>
    </div>
    <div class="col-md-4">
        <div class="kanban-column" id="column-completada">
            <h2>Completada</h2>
            {% for task in tasks_completada %}
                <div class="kanban-card" draggable="true" data-task-id="{{ task.id }}" data-status="completada">
                    {{ task.descripcion }}
                </div>
            {% else %}
                <p class="text-muted">No hay tareas completadas.</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    const socket = io();
    const columns = document.querySelectorAll('.kanban-column');
    let draggedItem = null;
    let originalParent = null; // Para almacenar la columna original

    columns.forEach(column => {
        column.addEventListener('dragstart', (e) => {
            draggedItem = e.target;
            originalParent = draggedItem.parentNode; // Guardar la columna original
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
            setTimeout(() => {
                e.target.classList.add('d-none');
            }, 0);
        });

        column.addEventListener('dragend', (e) => {
            e.target.classList.remove('d-none');
            draggedItem = null;
            originalParent = null;
        });

        column.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (e.target.classList.contains('kanban-column')) {
                e.target.classList.add('drag-over');
            }
        });

        column.addEventListener('dragleave', (e) => {
            e.target.classList.remove('drag-over');
        });

        column.addEventListener('drop', (e) => {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            if (e.target.classList.contains('kanban-column')) {
                const taskId = e.dataTransfer.getData('text/plain');
                const newStatus = e.target.id.replace('column-', '');
                
                // Mover la tarjeta visualmente
                e.target.appendChild(draggedItem);

                // Enviar la actualización al servidor
                fetch('/update_task_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ task_id: taskId, new_status: newStatus })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Estado de la tarea actualizado en el servidor.');
                        // Actualizar el data-status del elemento arrastrado
                        draggedItem.dataset.status = newStatus;
                    } else {
                        console.error('Error al actualizar el estado de la tarea:', data.message);
                        // Revertir el movimiento visual si falla la actualización del servidor
                        originalParent.appendChild(draggedItem); // Revertir
                        alert('Error al actualizar la tarea: ' + data.message); // Notificar al usuario
                    }
                })
                .catch(error => {
                    console.error('Error de red al actualizar el estado de la tarea:', error);
                    // Revertir el movimiento visual en caso de error de red
                    originalParent.appendChild(draggedItem); // Revertir
                    alert('Error de conexión al actualizar la tarea.'); // Notificar al usuario
                });
            }
        });
    });

    // SocketIO for real-time updates
    socket.on('task_status_updated', function(data) {
        const toastContainer = document.querySelector('.toast-container');
        let statusText = '';
        let category = 'info';

        switch(data.new_status) {
            case 'pendiente':
                statusText = 'pendiente';
                category = 'warning';
                break;
            case 'en_progreso':
                statusText = 'en progreso';
                category = 'primary';
                break;
            case 'completada':
                statusText = 'completada';
                category = 'success';
                break;
            default:
                statusText = data.new_status;
                category = 'info';
        }

        const toastHtml = `
            <div class="toast align-items-center text-white bg-${category} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        Tarea "${data.description}" actualizada a ${statusText}.
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        const toastElement = document.createRange().createContextualFragment(toastHtml);
        toastContainer.append(toastElement);
        const toast = new bootstrap.Toast(toastContainer.lastElementChild);
        toast.show();

        // Opcional: Mover la tarjeta visualmente si no fue arrastrada por este cliente
        // Esto es útil para sincronizar múltiples clientes
        const taskCard = document.querySelector(`[data-task-id="${data.task_id}"]`);
        if (taskCard && taskCard !== draggedItem) { // draggedItem es la tarjeta que este cliente arrastró
            const targetColumnId = `column-${data.new_status}`;
            const targetColumn = document.getElementById(targetColumnId);
            if (targetColumn) {
                targetColumn.appendChild(taskCard);
                taskCard.dataset.status = data.new_status;
            }
        }
    });
</script>
{% endblock %}