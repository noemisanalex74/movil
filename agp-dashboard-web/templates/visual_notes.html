
{% extends "base.html" %}

{% block title %}Notas Visuales - AGP Dashboard{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .note-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }
    .note-card img {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border-top-left-radius: var(--border-radius);
        border-top-right-radius: var(--border-radius);
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Notas Visuales</h1>

<!-- Add Note Form -->
<div class="card mb-4">
    <div class="card-body">
        <form id="add-note-form">
            <div class="mb-3">
                <label for="description" class="form-label">Descripción de la nueva nota:</label>
                <input type="text" id="description" name="description" class="form-control" placeholder="Ej: Pizarra de la reunión de hoy">
            </div>
            <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-camera-fill me-2"></i>Añadir Nueva Nota Visual
            </button>
        </form>
    </div>
</div>

<!-- Notes Gallery -->
<div id="notes-container" class="note-gallery">
    {% for note in notes %}
    <div class="card note-card" id="note-{{ note.id }}">
        <img src="{{ url_for('send_uploaded_file', filename=note.filename) }}" alt="{{ note.description }}">
        <div class="card-body">
            <p class="card-text">{{ note.description }}</p>
        </div>
        <div class="card-footer text-muted">
            {{ note.timestamp | format_datetime }}
        </div>
    </div>
    {% else %}
    <div class="text-center p-5 w-100">
        <h3>No hay notas visuales todavía.</h3>
        <p>Usa el formulario de arriba para añadir tu primera nota usando la cámara.</p>
    </div>
    {% endfor %}
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('add-note-form');
    const submitButton = form.querySelector('button[type="submit"]');
    const notesContainer = document.getElementById('notes-container');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const originalButtonText = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Abriendo cámara...';

        const formData = new FormData(form);

        try {
            const response = await fetch("{{ url_for('visual_notes.create_note') }}", {
                method: 'POST',
                body: formData
            });

            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';

            const result = await response.json();

            if (response.ok) {
                showToast('Éxito', 'Nota visual añadida correctamente.', 'success');
                form.reset();
                // Dynamically add the new note to the gallery
                const newNoteCard = `
                    <div class="card note-card fade-in" id="note-${result.id}">
                        <img src="/uploads/${result.filename}" alt="${result.description}">
                        <div class="card-body">
                            <p class="card-text">${result.description}</p>
                        </div>
                        <div class="card-footer text-muted">
                            ${new Date(result.timestamp).toLocaleString('es-ES')}
                        </div>
                    </div>
                `;
                notesContainer.insertAdjacentHTML('afterbegin', newNoteCard);
            } else {
                showToast('Error', result.error || 'No se pudo crear la nota.', 'danger');
            }

        } catch (error) {
            console.error("Error creating visual note:", error);
            showToast('Error de Red', 'No se pudo comunicar con el servidor.', 'danger');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        }
    });
});
</script>
{% endblock %}
